<%- include('../partials/header', { activePage: 'by-body-type', title: 'Kasa Tipleri' }) %>

<div class="container">
<h2 style="color: #1e3c72; margin-bottom: 20px; font-size: 1.5em; font-weight: 600;">Kasa Tipine Göre Satış Dağılımı</h2>

<table style="margin-top: 40px; margin-bottom: 20px;">
    <thead>
        <tr>
            <th>Kasa Tipi</th>
            <th>Toplam Satış</th>
        </tr>
    </thead>
    <tbody>
        <% if (byBodyType.length === 0) { %>
        <tr>
            <td colspan="2" style="text-align: center; padding: 40px; color: #999;">Veri bulunamadı.</td>
        </tr>
        <% } else { %>
        <% byBodyType.forEach(body => { %>
        <tr>
            <td><strong><%= body.body_type %></strong></td>
            <td><%= Number(body.total_sales).toLocaleString('tr-TR') %></td>
        </tr>
        <% }) %>
        <% } %>
    </tbody>
</table>

<h2 style="color: #1e3c72; margin-top: 60px; margin-bottom: 20px; font-size: 1.5em; font-weight: 600;">Şehirlere Göre Kasa Tipi Dağılımı</h2>

<div class="chart-container" style="padding: 0;">
  <div id="chart-by-city-body-type" style="width: 100%; min-height: 400px;"></div>
</div>
</div>

<script>
  async function loadCityBodyTypeData() {
    try {
      const response = await fetch('/api/city-body-type-data');
      const result = await response.json();
      
      if (result.success && result.data && result.data.length > 0) {
        updateCityBodyTypeHeatmap('chart-by-city-body-type', result.data);
      }
    } catch (error) {
      console.error('Veri yüklenirken hata:', error);
    }
  }

  function updateCityBodyTypeHeatmap(containerId, data) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Veri bulunamadı.</p>';
      return;
    }
    
    const cities = [...new Set(data.map(item => item.city_name).filter(Boolean))].sort();
    const bodyTypes = [...new Set(data.map(item => item.body_type).filter(Boolean))].sort();
    
    const heatmapData = {};
    let maxSales = 0;
    
    cities.forEach(city => {
      heatmapData[city] = {};
      bodyTypes.forEach(bodyType => {
        const item = data.find(d => d.city_name === city && d.body_type === bodyType);
        const sales = item ? item.total_sales : 0;
        heatmapData[city][bodyType] = sales;
        if (sales > maxSales) {
          maxSales = sales;
        }
      });
    });
    
    if (maxSales === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">Veri bulunamadı.</p>';
      return;
    }
    
    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.fontSize = '12px';
    
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const emptyCell = document.createElement('th');
    emptyCell.style.padding = '10px';
    emptyCell.style.border = '1px solid #ddd';
    emptyCell.style.backgroundColor = '#f5f5f5';
    emptyCell.style.fontWeight = 'bold';
    headerRow.appendChild(emptyCell);
    
    bodyTypes.forEach(bodyType => {
      const th = document.createElement('th');
      th.textContent = bodyType;
      th.style.padding = '10px';
      th.style.border = '1px solid #ddd';
      th.style.backgroundColor = '#f5f5f5';
      th.style.fontWeight = 'bold';
      th.style.textAlign = 'center';
      th.style.minWidth = '100px';
      headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    
    cities.forEach(city => {
      const row = document.createElement('tr');
      
      const cityCell = document.createElement('td');
      cityCell.textContent = city;
      cityCell.style.padding = '10px';
      cityCell.style.border = '1px solid #ddd';
      cityCell.style.backgroundColor = '#f5f5f5';
      cityCell.style.fontWeight = 'bold';
      cityCell.style.textAlign = 'left';
      row.appendChild(cityCell);
      
      bodyTypes.forEach(bodyType => {
        const sales = heatmapData[city][bodyType] || 0;
        const cell = document.createElement('td');
        cell.style.padding = '10px';
        cell.style.border = '1px solid #ddd';
        cell.style.textAlign = 'center';
        cell.style.cursor = 'pointer';
        cell.style.transition = 'opacity 0.2s';
        cell.style.position = 'relative';
        
        const intensity = maxSales > 0 ? sales / maxSales : 0;
        const colorValue = Math.floor(255 * (1 - intensity));
        cell.style.backgroundColor = `rgb(${colorValue}, ${colorValue}, 255)`;
        cell.style.color = intensity > 0.5 ? '#fff' : '#333';
        
        if (sales > 0) {
          cell.textContent = sales.toLocaleString('tr-TR');
        } else {
          cell.textContent = '-';
          cell.style.backgroundColor = '#f9f9f9';
          cell.style.color = '#999';
        }
        
        let tooltip = null;
        cell.addEventListener('mouseenter', function(e) {
          if (sales > 0) {
            if (!tooltip) {
              tooltip = document.createElement('div');
              tooltip.style.position = 'absolute';
              tooltip.style.background = 'rgba(0, 0, 0, 0.9)';
              tooltip.style.color = '#fff';
              tooltip.style.padding = '8px';
              tooltip.style.borderRadius = '4px';
              tooltip.style.fontSize = '11px';
              tooltip.style.zIndex = '1000';
              tooltip.style.pointerEvents = 'none';
              tooltip.style.whiteSpace = 'nowrap';
              tooltip.textContent = `${city} - ${bodyType}: ${sales.toLocaleString('tr-TR')}`;
              document.body.appendChild(tooltip);
            }
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
            tooltip.style.display = 'block';
            
            this.style.opacity = '0.8';
          }
        });
        
        cell.addEventListener('mouseleave', function() {
          if (tooltip) {
            tooltip.style.display = 'none';
          }
          this.style.opacity = '1';
        });
        
        row.appendChild(cell);
      });
      
      tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    container.appendChild(table);
  }

  loadCityBodyTypeData();
</script>

<%- include('../partials/footer') %>

